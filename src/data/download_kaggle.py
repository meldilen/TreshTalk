import os
from pathlib import Path
from kaggle.api.kaggle_api_extended import KaggleApi
import shutil

DATASETS = {
    "trashnet": "feyzazkefe/trashnet",
    "WaRP": "parohod/warp-waste-recycling-plant-dataset",
    "12classes": "mostafaabla/garbage-classification",
    "garbage_classification_1": "asdasdasasdas/garbage-classification",
    "trash_type": "farzadnekouei/trash-type-image-dataset",
    "realwaste": "joebeachcapital/realwaste",
    "garbage_classification_2": "zlatan599/garbage-dataset-classification",
    "garbage_dataset": "sumn2u/garbage-classification-v2"
}

SCRIPT_DIR = Path(__file__).parent.parent.parent
RAW_DIR = SCRIPT_DIR / "data" / "raw"


DATASET_CONFIGS = {
    "garbage_classification_1": {
        "source_path": "Garbage classification/Garbage classification",
        "classes": ['cardboard', 'glass', 'metal', 'paper', 'plastic', 'trash'],
        "remove_files": ["*.txt"]
    },
    "garbage_classification_2": {
        "source_path": "Garbage_Dataset_Classification/images",
        "classes": ['cardboard', 'glass', 'metal', 'paper', 'plastic', 'trash'],
        "remove_files": ["*.csv", "*.json", "metadata.*"]
    },
    "realwaste": {
        "source_path": "realwaste-main/RealWaste",
        "classes": ['Cardboard', 'Food Organics', 'Glass', 'Metal',
                    'Miscellaneous Trash', 'Paper', 'Plastic',
                    'Textile Trash', 'Vegetation'],
        "remove_files": ["*.md", "*.txt", "README*", "LICENSE*"]
    }
}


def merge_warp_c_folders():
    """–û–±—ä–µ–¥–∏–Ω—è–µ—Ç –ø–∞–ø–∫–∏ test_crops –∏ train_crops –≤ Warp-C"""
    warp_dir = RAW_DIR / "WaRP"

    if not warp_dir.exists():
        print("–ü–∞–ø–∫–∞ WaRP –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!")
        return

    warp_c_dir = warp_dir / "Warp-C"
    if not warp_c_dir.exists():
        print("–ü–∞–ø–∫–∞ Warp-C –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!")
        return

    test_crops_dir = warp_c_dir / "test_crops"
    train_crops_dir = warp_c_dir / "train_crops"

    if not test_crops_dir.exists() or not train_crops_dir.exists():
        print("–ù–µ –Ω–∞–π–¥–µ–Ω—ã –ø–∞–ø–∫–∏ test_crops –∏–ª–∏ train_crops!")
        return

    merged_dir = warp_c_dir / "merged_crops"
    merged_dir.mkdir(exist_ok=True)

    for category in test_crops_dir.iterdir():
        if not category.is_dir():
            continue

        print(f"üìÅ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é: {category.name}")

        train_category_dir = train_crops_dir / category.name

        if not train_category_dir.exists():
            print(
                f"‚ö†Ô∏è –ö–∞—Ç–µ–≥–æ—Ä–∏—è {category.name} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ train_crops, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º")
            continue

        for subfolder in category.iterdir():
            if not subfolder.is_dir():
                continue

            subfolder_name = subfolder.name
            train_subfolder = train_category_dir / subfolder_name

            if not train_subfolder.exists():
                print(
                    f"‚ö†Ô∏è –ü–æ–¥–ø–∞–ø–∫–∞ {subfolder_name} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ train, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º")
                continue

            target_dir = merged_dir / subfolder_name
            target_dir.mkdir(exist_ok=True)

            for file in subfolder.iterdir():
                if file.is_file():
                    target_file = target_dir / file.name
                    if not target_file.exists():
                        shutil.copy2(file, target_file)

            for file in train_subfolder.iterdir():
                if file.is_file():
                    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è, –µ—Å–ª–∏ —Ñ–∞–π–ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                    target_file = target_dir / file.name
                    if target_file.exists():
                        # –î–æ–±–∞–≤–ª—è–µ–º —Å—É—Ñ—Ñ–∏–∫—Å –∫ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
                        stem = file.stem
                        suffix = file.suffix
                        counter = 1
                        while target_file.exists():
                            new_name = f"{stem}_train_{counter}{suffix}"
                            target_file = target_dir / new_name
                            counter += 1

                    shutil.copy2(file, target_file)

            print(f"‚úÖ –û–±—ä–µ–¥–∏–Ω–µ–Ω–æ: {subfolder_name}")

    print(f"üéâ –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ! –†–µ–∑—É–ª—å—Ç–∞—Ç –≤: {merged_dir}")

    print("üóëÔ∏è –£–¥–∞–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –ø–∞–ø–∫–∏ test_crops –∏ train_crops...")
    try:
        shutil.rmtree(test_crops_dir)
        print("‚úÖ –£–¥–∞–ª–µ–Ω–∞ test_crops")
        shutil.rmtree(train_crops_dir)
        print("‚úÖ –£–¥–∞–ª–µ–Ω–∞ train_crops")
    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–∞–ø–æ–∫: {e}")


def cleanup_warp_directory():
    """–û—á–∏—â–∞–µ—Ç –ø–∞–ø–∫—É WaRP, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ merged_crops"""
    warp_dir = RAW_DIR / "WaRP"

    if not warp_dir.exists():
        print("–ü–∞–ø–∫–∞ WaRP –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏!")
        return

    print("üßπ –û—á–∏—â–∞–µ–º –ø–∞–ø–∫—É WaRP...")

    merged_crops_path = None

    # –ò—â–µ–º merged_crops –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ
    for root, dirs, files in os.walk(warp_dir):
        if "merged_crops" in dirs:
            merged_crops_path = Path(root) / "merged_crops"
            break

    if not merged_crops_path or not merged_crops_path.exists():
        print("–ü–∞–ø–∫–∞ merged_crops –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!")
        return

    # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è merged_crops
    temp_dir = warp_dir.parent / "WaRP_temp"
    temp_dir.mkdir(exist_ok=True)

    try:
        # –ü–µ—Ä–µ–º–µ—â–∞–µ–º merged_crops –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É
        temp_merged = temp_dir / "merged_crops"
        shutil.move(str(merged_crops_path), str(temp_merged))
        print("‚úÖ merged_crops –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É")

        shutil.rmtree(warp_dir)
        print("‚úÖ –ü–∞–ø–∫–∞ WaRP —É–¥–∞–ª–µ–Ω–∞")

        warp_dir.mkdir(parents=True, exist_ok=True)

        shutil.move(str(temp_merged), str(warp_dir / "merged_crops"))
        print("‚úÖ merged_crops –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∞ –≤ –æ—á–∏—â–µ–Ω–Ω—É—é –ø–∞–ø–∫—É WaRP")

        shutil.rmtree(temp_dir)
        print("‚úÖ –í—Ä–µ–º–µ–Ω–Ω–∞—è –ø–∞–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∞")

        print("üéâ –ü–∞–ø–∫–∞ WaRP —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω–∞! –û—Å—Ç–∞–ª–∞—Å—å —Ç–æ–ª—å–∫–æ merged_crops")

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –ø–∞–ø–∫–∏ WaRP: {e}")
        if temp_dir.exists():
            if (temp_dir / "merged_crops").exists():
                shutil.move(str(temp_dir / "merged_crops"),
                            str(warp_dir / "merged_crops"))
            shutil.rmtree(temp_dir)

def organize_dataset(dataset_name):
    """–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞—Ç–∞—Å–µ—Ç–æ–≤"""
    dataset_dir = RAW_DIR / dataset_name
    
    if not dataset_dir.exists():
        print(f"–ü–∞–ø–∫–∞ {dataset_name} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!")
        return False
    
    config = DATASET_CONFIGS.get(dataset_name)
    if not config:
        print(f"‚ùå –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è {dataset_name} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!")
        return False
    
    print(f"\nüìÅ –û—Ä–≥–∞–Ω–∏–∑—É–µ–º –¥–∞—Ç–∞—Å–µ—Ç: {dataset_name}")
    
    # –ò—â–µ–º –∏—Å—Ö–æ–¥–Ω—É—é –ø–∞–ø–∫—É —Å –¥–∞–Ω–Ω—ã–º–∏
    source_dir = dataset_dir / config["source_path"]
    
    moved_count = 0
    classes_found = []
    
    for class_dir in source_dir.iterdir():
        if class_dir.is_dir():
            class_name = class_dir.name
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–ª–∞—Å—Å (–±–µ–∑ —É—á–µ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞)
            class_name_lower = class_name.lower()
            config_classes_lower = [c.lower() for c in config["classes"]]
            
            if class_name_lower not in config_classes_lower:
                print(f"‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–ª–∞—Å—Å: {class_name}, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º")
                continue
            
            # –ù–∞—Ö–æ–¥–∏–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∞ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
            correct_class_name = next((c for c in config["classes"] if c.lower() == class_name_lower), class_name)
            
            target_dir = dataset_dir / correct_class_name
            classes_found.append(correct_class_name)
            
            print(f"‚û°Ô∏è –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º: {class_name} -> {correct_class_name}")
            
            # –ï—Å–ª–∏ —Ü–µ–ª–µ–≤–∞—è –ø–∞–ø–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –æ–±—ä–µ–¥–∏–Ω—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            if target_dir.exists():
                files_copied = 0
                for file_path in class_dir.glob("*.*"):
                    if file_path.is_file() and file_path.suffix.lower() in ['.jpg', '.jpeg', '.png', '.bmp']:
                        target_file = target_dir / file_path.name
                        # –ï—Å–ª–∏ —Ñ–∞–π–ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –¥–æ–±–∞–≤–ª—è–µ–º —Å—É—Ñ—Ñ–∏–∫—Å
                        if target_file.exists():
                            stem = file_path.stem
                            suffix = file_path.suffix
                            counter = 1
                            while target_file.exists():
                                new_name = f"{stem}_{counter}{suffix}"
                                target_file = target_dir / new_name
                                counter += 1
                        shutil.copy2(file_path, target_file)
                        files_copied += 1
                        moved_count += 1
                print(f"  ‚úÖ –û–±—ä–µ–¥–∏–Ω–µ–Ω–æ {files_copied} —Ñ–∞–π–ª–æ–≤ –≤ {correct_class_name}")
            else:
                # –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–º–µ—â–∞–µ–º –≤—Å—é –ø–∞–ø–∫—É
                shutil.move(str(class_dir), str(target_dir))
                file_count = len([f for f in target_dir.glob("*.*") if f.is_file()])
                moved_count += file_count
                print(f"  ‚úÖ –ü–µ—Ä–µ–º–µ—â–µ–Ω–æ {file_count} —Ñ–∞–π–ª–æ–≤ –≤ {correct_class_name}")
    
    try:
        current_dir = source_dir
        while current_dir != dataset_dir:
            if current_dir.exists() and not any(current_dir.iterdir()):
                shutil.rmtree(current_dir)
                print(f"üóëÔ∏è –£–¥–∞–ª–µ–Ω–∞ –ø—É—Å—Ç–∞—è –ø–∞–ø–∫–∞: {current_dir.name}")
            parent_dir = current_dir.parent
            if parent_dir == current_dir:  # –î–æ—Å—Ç–∏–≥–ª–∏ –∫–æ—Ä–Ω—è
                break
            current_dir = parent_dir
    except Exception as e:
        print(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–µ –ø–∞–ø–∫–∏: {e}")
    
    files_removed = 0
    for pattern in config["remove_files"]:
        for file_path in dataset_dir.glob(pattern):
            try:
                if file_path.is_file():
                    file_path.unlink()
                    files_removed += 1
                    print(f"üóëÔ∏è –£–¥–∞–ª–µ–Ω —Ñ–∞–π–ª: {file_path.name}")
            except Exception as e:
                print(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å {file_path.name}: {e}")
    
    if files_removed > 0:
        print(f"üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ {files_removed} —Å–ª—É–∂–µ–±–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤")
    
    print(f"\nüéâ –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è {dataset_name} –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
    return True

def main():
    RAW_DIR.mkdir(parents=True, exist_ok=True)
    api = KaggleApi()
    api.authenticate()

    for name, slug in DATASETS.items():
        out_dir = RAW_DIR / name
        out_dir.mkdir(parents=True, exist_ok=True)
        print(f"Downloading {name} -> {out_dir}")
        api.dataset_download_files(slug, path=str(
            out_dir), unzip=True, quiet=False)
        print(f"‚úÖ Done: {name}")

    if "WaRP" in DATASETS:
        merge_warp_c_folders()
        cleanup_warp_directory()

    datasets_to_organize = ["garbage_classification_1", "garbage_classification_2", "realwaste"]
    for dataset_name in datasets_to_organize:
        if dataset_name in DATASETS:
            organize_dataset(dataset_name)


if __name__ == "__main__":
    main()
